<%# Listado de productos sin formas ni leyenda. Incluye columna "Procedencia" con popover de categorías y proveedores %>
<h1>Productos</h1>
<a href="/productos/nuevo?returnTo=<%= encodeURIComponent(request.originalUrl) %>" class="btn btn-success mb-3">Nuevo</a>
<button class="btn btn-outline-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#searchBox">Buscar</button>
<div id="searchBox" class="collapse"><!-- Siempre cerrado; se abre solo al pulsar "Buscar" -->
  <% if (errors && errors.length) { %>
    <div class="alert alert-warning">
      <strong>Revisa los filtros:</strong>
      <ul class="mb-0">
        <% errors.forEach(e => { %><li><%= e.path %>: <%= e.msg %></li><% }) %>
      </ul>
    </div>
  <% } %>
  <!-- Filtros de búsqueda. Envían GET a la ruta base y mantienen valores actuales -->
  <form class="row g-3" method="get" action="<%= basePath %>" data-search="productos">
    <div class="col-md-3">
      <input type="text" name="qName" class="form-control" placeholder="Nombre" value="<%= query.qName || '' %>">
    </div>
    <div class="col-md-3">
      <div class="d-flex gap-2">
        <select name="priceOp" class="form-select" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="Selecciona operador (=, ≤, ≥). Si no eliges ninguno, se usa '=' por defecto.">
          <option value="">Precio</option>
          <option value="eq" <%= query.priceOp==='eq'?'selected':'' %>>=</option>
          <option value="lte" <%= query.priceOp==='lte'?'selected':'' %>>&le;</option>
          <option value="gte" <%= query.priceOp==='gte'?'selected':'' %>>&ge;</option>
        </select>
        <input type="number" step="0.01" name="price" class="form-control" placeholder="num" value="<%= query.price || '' %>">
      </div>
    </div>
    <div class="col-md-3">
      <div class="d-flex gap-2">
        <select name="stockOp" class="form-select" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="Selecciona operador (=, ≤, ≥). Si no eliges ninguno, se usa '=' por defecto.">
          <option value="">Stock</option>
          <option value="eq" <%= query.stockOp==='eq'?'selected':'' %>>=</option>
          <option value="lte" <%= query.stockOp==='lte'?'selected':'' %>>&le;</option>
          <option value="gte" <%= query.stockOp==='gte'?'selected':'' %>>&ge;</option>
        </select>
        <input type="number" name="stock" class="form-control" placeholder="num" value="<%= query.stock || '' %>">
      </div>
    </div>
    <div class="col-md-3">
      <div class="d-flex gap-2">
        <select name="minOp" class="form-select" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="Selecciona operador (=, ≤, ≥). Si no eliges ninguno, se usa '=' por defecto.">
          <option value="">Stock mín.</option>
          <option value="eq" <%= query.minOp==='eq'?'selected':'' %>>=</option>
          <option value="lte" <%= query.minOp==='lte'?'selected':'' %>>&le;</option>
          <option value="gte" <%= query.minOp==='gte'?'selected':'' %>>&ge;</option>
        </select>
        <input type="number" name="min" class="form-control" placeholder="num" value="<%= query.min || '' %>">
      </div>
    </div>
    <div class="col-md-3">
      <select name="localizacionId" class="form-select">
        <option value="">Localización</option>
        <% localizaciones.forEach(l => { %>
          <option value="<%= l.id %>" <%= Number(query.localizacionId) === l.id ? 'selected' : '' %>><%= l.nombre %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <select name="categoriaId" class="form-select">
        <option value="">Categoría</option>
        <% categorias.forEach(c => { %>
          <option value="<%= c.id %>" <%= Number(query.categoriaId) === c.id ? 'selected' : '' %>><%= c.nombre %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <select name="proveedorId" class="form-select">
        <option value="">Proveedor</option>
        <% proveedores.forEach(p => { %>
          <option value="<%= p.id %>" <%= Number(query.proveedorId) === p.id ? 'selected' : '' %>><%= p.nombre %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-center">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="low" value="1" id="lowChk" <%= query.low === '1' ? 'checked' : '' %>>
        <label class="form-check-label" for="lowChk">Bajo stock</label>
      </div>
    </div>
    <div class="col-md-3">
      <select name="sortBy" class="form-select">
        <option value="id" <%= (query.sortBy || 'id')==='id' ? 'selected' : '' %>>Ordenar por ID</option>
        <option value="nombre" <%= query.sortBy==='nombre'?'selected':'' %>>Nombre</option>
        <option value="precio" <%= query.sortBy==='precio'?'selected':'' %>>Precio</option>
        <option value="costo" <%= query.sortBy==='costo'?'selected':'' %>>Costo</option>
        <option value="stock" <%= query.sortBy==='stock'?'selected':'' %>>Stock</option>
        <option value="stock_minimo" <%= query.sortBy==='stock_minimo'?'selected':'' %>>Stock mínimo</option>
        <option value="localizacion" <%= query.sortBy==='localizacion'?'selected':'' %>>Localización</option>
      </select>
    </div>
    <div class="col-md-3">
      <select name="sortDir" class="form-select">
        <option value="asc" <%= (query.sortDir || 'asc')==='asc' ? 'selected' : '' %>>Asc</option>
        <option value="desc" <%= (query.sortDir || 'asc')==='desc' ? 'selected' : '' %>>Desc</option>
      </select>
    </div>
    <!-- Botones de acción: aplicar filtros o volver a la ruta base -->
    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Aplicar</button>
      <a class="btn btn-outline-secondary" href="<%= basePath %>">Limpiar</a>
    </div>
  </form>
</div>
<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Precio</th>
      <th>Costo</th>
      <th>Stock</th>
      <th>Stock mínimo</th>
      <th>Descripción</th>
      <th>Observaciones</th>
      <th>Procedencia</th>
      <th>Localización</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    <% productos.forEach(p => { %>
      <tr class="<%= p.stock < p.stock_minimo ? 'table-warning' : '' %>">
        <td><%= p.id %></td>
        <td><%= p.nombre %></td>
        <td><%= p.precio %></td>
        <td><%= p.costo %></td>
        <td><%= p.stock %> <% if (p.stock < p.stock_minimo) { %><span class="badge badge-bajo-stock">Bajo stock</span><% } %></td>
        <td><%= p.stock_minimo %></td>
        <td>
          <% if (p.descripcion) { %>
            <i class='bx bx-info-circle' data-bs-toggle="tooltip" title="<%= p.descripcion %>"></i>
          <% } %>
        </td>
        <td>
          <% if (p.observaciones) { %>
            <i class='bx bx-info-circle' data-bs-toggle="tooltip" title="<%= p.observaciones %>"></i>
          <% } %>
        </td>
        <td class="procedencia-cell">
          <% const cats = p.categorias.length ? p.categorias.map(c=>c.nombre).join(', ') : '—';
             const provs = p.proveedores.length ? p.proveedores.map(pr=>pr.nombre).join(', ') : '—'; %>
          <button type="button" class="btn btn-sm btn-outline-secondary procedencia-btn" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="left" data-bs-html="true" title="Procedencia" data-bs-content="<strong>Categorías:</strong> <%= cats %><br><strong>Proveedores:</strong> <%= provs %>">
            <i class="bx bx-info-circle" aria-hidden="true"></i><span class="visually-hidden">Ver procedencia</span>
          </button>
        </td>
        <td><%= p.localizacion || '-' %></td>
        <td>
          <a href="/productos/<%= p.id %>?returnTo=<%= encodeURIComponent(request.originalUrl) %>" class="btn btn-sm btn-primary"><i class='bx bx-show'></i></a>
          <a href="/productos/<%= p.id %>/editar?returnTo=<%= encodeURIComponent(request.originalUrl) %>" class="btn btn-sm btn-warning"><i class='bx bx-edit'></i></a>
          <form action="/productos/<%= p.id %>/eliminar" method="POST" class="d-inline">
            <input type="hidden" name="returnTo" value="<%= request.originalUrl %>">
            <button type="submit" class="btn btn-sm btn-danger btn-delete"><i class='bx bx-trash'></i></button>
          </form>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>
<%
  const params = new URLSearchParams(query);
%>
<nav>
  <ul class="pagination">
    <% for(let i=1;i<=totalPages;i++){ params.set('page', i); %>
      <li class="page-item <%= i===page ? 'active' : '' %>"><a class="page-link" href="<%= basePath %>?<%= params.toString() %>"><%= i %></a></li>
    <% } %>
  </ul>
</nav>
<!-- [checklist] Requisito implementado | Validación aplicada | SQL parametrizado (si aplica) | Comentarios modo curso | Sin código muerto -->
