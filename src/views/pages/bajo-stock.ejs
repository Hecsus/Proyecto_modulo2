<h1>Bajo stock</h1>
<button class="btn btn-outline-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#searchBox">Buscar</button>
<div id="searchBox" class="collapse"><!-- Collapse cerrado por defecto -->
  <% if (errors && errors.length) { %>
    <div class="alert alert-warning">
      <strong>Revisa los filtros:</strong>
      <ul class="mb-0">
        <% errors.forEach(e => { %><li><%= e.path %>: <%= e.msg %></li><% }) %>
      </ul>
    </div>
  <% } %>
  <form class="row g-3" method="get" action="<%= basePath %>" data-search="bajoStock">
    <div class="col-md-3">
      <input type="text" name="qName" class="form-control" placeholder="Nombre" value="<%= query.qName || '' %>">
    </div>
    <div class="col-md-3">
      <div class="d-flex gap-2">
        <select name="priceOp" class="form-select" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="Selecciona operador (=, ≤, ≥). Si no eliges ninguno, se usa '=' por defecto.">
          <option value="">Precio</option>
          <option value="eq" <%= query.priceOp==='eq'?'selected':'' %>>=</option>
          <option value="lte" <%= query.priceOp==='lte'?'selected':'' %>>&le;</option>
          <option value="gte" <%= query.priceOp==='gte'?'selected':'' %>>&ge;</option>
        </select>
        <input type="number" step="0.01" name="price" class="form-control" placeholder="num" value="<%= query.price || '' %>">
      </div>
    </div>
    <div class="col-md-3">
      <div class="d-flex gap-2">
        <select name="stockOp" class="form-select" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="Selecciona operador (=, ≤, ≥). Si no eliges ninguno, se usa '=' por defecto.">
          <option value="">Stock</option>
          <option value="eq" <%= query.stockOp==='eq'?'selected':'' %>>=</option>
          <option value="lte" <%= query.stockOp==='lte'?'selected':'' %>>&le;</option>
          <option value="gte" <%= query.stockOp==='gte'?'selected':'' %>>&ge;</option>
        </select>
        <input type="number" name="stock" class="form-control" placeholder="num" value="<%= query.stock || '' %>">
      </div>
    </div>
    <div class="col-md-3">
      <div class="d-flex gap-2">
        <select name="minOp" class="form-select" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="Selecciona operador (=, ≤, ≥). Si no eliges ninguno, se usa '=' por defecto.">
          <option value="">Stock mín.</option>
          <option value="eq" <%= query.minOp==='eq'?'selected':'' %>>=</option>
          <option value="lte" <%= query.minOp==='lte'?'selected':'' %>>&le;</option>
          <option value="gte" <%= query.minOp==='gte'?'selected':'' %>>&ge;</option>
        </select>
        <input type="number" name="min" class="form-control" placeholder="num" value="<%= query.min || '' %>">
      </div>
    </div>
    <div class="col-md-3">
      <select name="localizacionId" class="form-select">
        <option value="">Localización</option>
        <% localizaciones.forEach(l => { %>
          <option value="<%= l.id %>" <%= Number(query.localizacionId) === l.id ? 'selected' : '' %>><%= l.nombre %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <select name="categoriaId" class="form-select">
        <option value="">Categoría</option>
        <% categorias.forEach(c => { %>
          <option value="<%= c.id %>" <%= Number(query.categoriaId) === c.id ? 'selected' : '' %>><%= c.nombre %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <select name="proveedorId" class="form-select">
        <option value="">Proveedor</option>
        <% proveedores.forEach(p => { %>
          <option value="<%= p.id %>" <%= Number(query.proveedorId) === p.id ? 'selected' : '' %>><%= p.nombre %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <select name="sortBy" class="form-select">
        <option value="id" <%= (query.sortBy || 'id')==='id' ? 'selected' : '' %>>Ordenar por ID</option>
        <option value="nombre" <%= query.sortBy==='nombre'?'selected':'' %>>Nombre</option>
        <option value="precio" <%= query.sortBy==='precio'?'selected':'' %>>Precio</option>
        <option value="costo" <%= query.sortBy==='costo'?'selected':'' %>>Costo</option>
        <option value="stock" <%= query.sortBy==='stock'?'selected':'' %>>Stock</option>
        <option value="stock_minimo" <%= query.sortBy==='stock_minimo'?'selected':'' %>>Stock mínimo</option>
        <option value="localizacion" <%= query.sortBy==='localizacion'?'selected':'' %>>Localización</option>
      </select>
    </div>
    <div class="col-md-3">
      <select name="sortDir" class="form-select">
        <option value="asc" <%= (query.sortDir || 'asc')==='asc' ? 'selected' : '' %>>Asc</option>
        <option value="desc" <%= (query.sortDir || 'asc')==='desc' ? 'selected' : '' %>>Desc</option>
      </select>
    </div>
    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Aplicar</button>
      <a class="btn btn-outline-secondary" href="<%= basePath %>">Limpiar</a>
    </div>
  </form>
</div>
<%- include('../partials/legend-shapes') %><!-- Leyenda de formas -->
<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Precio</th>
      <th>Costo</th>
      <th>Stock</th>
      <th>Stock mínimo</th>
      <th>Descripción</th>
      <th>Observaciones</th>
      <th>Localización</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    <% productos.forEach(p => { %>
      <tr class="table-warning">
        <td><%= p.id %></td>
        <td>
          <!-- Nombre y símbolos: categorías (círculos), proveedores (cuadrados) y localización (triángulo) -->
          <div class="product-name-row">
            <div class="product-name-text"><%= p.nombre %></div>
            <div class="d-flex align-items-center">
              <% if (p.categorias.length || p.proveedores.length) { %>
                <div class="shape-stack">
                  <% if (p.categorias.length) { %>
                    <div class="shape-row">
                      <% p.categorias.forEach(c => { const bucket = c.id % 12; %>
                        <span class="shape shape-circle shape-bucket-<%= bucket %>" data-bs-toggle="tooltip" title="Categoría: <%= c.nombre %>"></span>
                      <% }) %>
                    </div>
                  <% } %>
                  <% if (p.proveedores.length) { %>
                    <div class="shape-row">
                      <% p.proveedores.forEach(pr => { const bucket = pr.id % 12; %>
                        <span class="shape shape-square shape-bucket-<%= bucket %>" data-bs-toggle="tooltip" title="Proveedor: <%= pr.nombre %>"></span>
                      <% }) %>
                    </div>
                  <% } %>
                </div>
              <% } %>
              <% if (p.localizacion) { const bucket = p.localizacion_id % 12; %>
                <span class="shape shape-triangle shape-bucket-<%= bucket %>" data-bs-toggle="tooltip" title="Localización: <%= p.localizacion %>"></span>
              <% } %>
            </div>
          </div>
        </td>
        <td><%= p.precio %></td>
        <td><%= p.costo %></td>
        <td><%= p.stock %></td>
        <td><%= p.stock_minimo %></td>
        <td>
          <% if (p.descripcion) { %>
            <i class='bx bx-info-circle' data-bs-toggle="tooltip" title="<%= p.descripcion %>"></i>
          <% } %>
        </td>
        <td>
          <% if (p.observaciones) { %>
            <i class='bx bx-info-circle' data-bs-toggle="tooltip" title="<%= p.observaciones %>"></i>
          <% } %>
        </td>
        <td>
          <% if (p.localizacion) { const bucket = p.localizacion_id % 12; %>
            <span class="shape shape-triangle shape-bucket-<%= bucket %>" data-bs-toggle="tooltip" title="Localización: <%= p.localizacion %>"></span>
            <%= p.localizacion %>
          <% } %>
        </td>
        <td>
          <a href="/productos/<%= p.id %>?returnTo=<%= encodeURIComponent(request.originalUrl) %>" class="btn btn-sm btn-primary"><i class='bx bx-show'></i></a>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>
<%
  const params = new URLSearchParams(query);
%>
<nav>
  <ul class="pagination">
    <% for(let i=1;i<=totalPages;i++){ params.set('page', i); %>
      <li class="page-item <%= i===page ? 'active' : '' %>"><a class="page-link" href="<%= basePath %>?<%= params.toString() %>"><%= i %></a></li>
    <% } %>
  </ul>
</nav>
